<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa V34 - Selecci√≥n T√°ctil</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS --- */
        body { margin: 0; padding: 0; background: #2b2b2b; overflow: hidden; font-family: 'Roboto', sans-serif; }
        #map { width: 100vw; height: 100vh; background: #2b2b2b; }

        /* MODAL INICIO (Ahora permite ver detr√°s) */
        #modal-inicio {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); /* Un poco m√°s transparente */
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(3px); /* Efecto borroso bonito */
        }
        
        .modal-box { 
            background: white; padding: 25px; border-radius: 20px; 
            width: 85%; max-width: 320px; text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h2 { margin-top: 0; color: #333; }
        
        #start-select { 
            width: 100%; padding: 12px; margin: 15px 0; 
            font-size: 16px; border: 1px solid #ddd; border-radius: 8px; 
            background: #f9f9f9;
        }

        /* Botones del Modal */
        .btn-confirm { 
            width: 100%; padding: 12px; background: #27ae60; color: white; 
            border: none; border-radius: 8px; font-weight: bold; font-size: 16px; 
            cursor: pointer; margin-bottom: 10px;
        }
        
        .btn-mapa {
            width: 100%; padding: 12px; background: white; color: #1a73e8; 
            border: 2px solid #1a73e8; border-radius: 8px; font-weight: bold; font-size: 16px; 
            cursor: pointer;
        }

        /* BARRA BUSCADOR */
        #search-container {
            position: fixed; top: 15px; left: 15px; right: 15px; z-index: 1000;
            background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
        }
        #search-select { width: 100%; padding: 14px; border: none; background: transparent; font-size: 16px; outline: none; }

        /* TARJETA INFO */
        #info-card {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; z-index: 1000;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
            transform: translateY(110%); transition: transform 0.3s ease;
            padding: 20px; box-sizing: border-box;
        }
        #info-card.visible { transform: translateY(0); }
        
        .route-stats { display: flex; align-items: baseline; margin-bottom: 10px; }
        .stat-time { font-size: 24px; font-weight: 700; color: #188038; margin-right: 10px; }
        .stat-dist { font-size: 16px; color: #666; }
        
        .btn-reset { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; background: #d93025; color: white; cursor: pointer; }

        /* ICONOS */
        .punto-rojo { background-color: #ea4335; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 5px black; }
        .flecha-azul { width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 26px solid #4285f4; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.4)); }
        
        .icon-marker { background: white; border-radius: 50%; border: 2px solid #666; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px black; }
        .icon-wc { border-color: #3498db; color: #3498db; } 
        .icon-stair { border-color: #27ae60; color: #27ae60; } 
        .icon-lift { border-color: #9b59b6; color: #9b59b6; } 
    </style>
</head>
<body>

    <div id="modal-inicio">
        <div class="modal-box">
            <h2>üìç ¬øD√≥nde est√°s?</h2>
            
            <select id="start-select">
                <option value="" disabled selected>üëá Busca en la lista...</option>
            </select>
            <button class="btn-confirm" onclick="confirmarInicio()">‚úÖ Confirmar</button>
            
            <div style="margin: 10px 0; color: #aaa;">‚Äî O ‚Äî</div>

            <button class="btn-mapa" onclick="activarModoMapa()">üëÜ Tocar en el mapa</button>
        </div>
    </div>

    <div id="aviso-mapa" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; z-index:2000; font-weight:bold;">
        Toca un punto rojo üî¥
    </div>

    <div id="search-container">
        <select id="search-select" onchange="gestionarBusqueda(this.value)">
            <option value="" disabled selected>üîç ¬øA d√≥nde quieres ir?</option>
            <optgroup label="ACCESOS R√ÅPIDOS">
                <option value="TYPE_WC">üöΩ Ba√±o m√°s cercano</option>
                <option value="TYPE_LIFT">üõó Ascensor m√°s cercano</option>
                <option value="TYPE_STAIR">ü™ú Escalera m√°s cercana</option>
            </optgroup>
            <optgroup label="LUGARES" id="opt-lugares"></optgroup>
        </select>
    </div>

    <div id="map"></div>

    <div id="info-card">
        <div class="card-header">
            <span id="card-title" style="font-weight:bold; font-size:18px; color:#333;">Ruta calculada</span>
        </div>
        <div class="route-stats">
            <span id="lbl-time" class="stat-time">--</span>
            <span id="lbl-dist" class="stat-dist">(-- m)</span>
        </div>
        <button class="btn-reset" onclick="location.reload()">‚ùå Terminar</button>
    </div>

    <script>
        const VELOCIDAD = 27; 

        const nodos = {
            "p1": { x: 272, y: 368, nombre: "Punto 1" }, "p2": { x: 255, y: 360, nombre: "Punto 2" },
            "p3": { x: 272, y: 329, nombre: "Punto 3" }, "p4": { x: 291, y: 328, nombre: "Punto 4" },
            "p5": { x: 311, y: 265, nombre: "Punto 5" }, "p6": { x: 190, y: 280, nombre: "Punto 6" },
            "p7": { x: 164, y: 275, nombre: "Punto 7" }, "p8": { x: 155, y: 286, nombre: "Punto 8" },
            "p9": { x: 118, y: 275, nombre: "Punto 9" }, "p10": { x: 92, y: 276, nombre: "Punto 10" },
            "p11": { x: 89, y: 271, nombre: "Punto 11" }, "p12": { x: 230, y: 255, nombre: "Punto 12" },
            "p13": { x: 242, y: 257, nombre: "Punto 13" }, "p14": { x: 231, y: 236, nombre: "Punto 14" },
            "p15": { x: 242, y: 235, nombre: "Punto 15" }, "p16": { x: 232, y: 184, nombre: "Punto 16" },
            "p17": { x: 241, y: 181, nombre: "Punto 17" }, "p18": { x: 242, y: 165, nombre: "Punto 18" },
            "p19": { x: 273, y: 165, nombre: "Punto 19" }, "p20": { x: 294, y: 173, nombre: "Punto 20" },
            "p21": { x: 308, y: 173, nombre: "Punto 21" }, "p22": { x: 327, y: 167, nombre: "Punto 22" },
            "p23": { x: 416, y: 158, nombre: "Punto 23" }, "p24": { x: 469, y: 165, nombre: "Punto 24" },
            "p25": { x: 488, y: 165, nombre: "Punto 25" }, "p26": { x: 476, y: 144, nombre: "Punto 26" },
            "p27": { x: 475, y: 123, nombre: "Punto 27" }, "p28": { x: 544, y: 114, nombre: "Punto 28" },
            "p29": { x: 529, y: 174, nombre: "Punto 29" }, "p30": { x: 529, y: 200, nombre: "Punto 30" },
            "p31": { x: 505, y: 220, nombre: "Punto 31" }, "p32": { x: 529, y: 244, nombre: "Punto 32" },
            "p33": { x: 530, y: 285, nombre: "Punto 33" }, "p34": { x: 518, y: 258, nombre: "Punto 34" },
            "p35": { x: 452, y: 253, nombre: "Punto 35" }, "p36": { x: 543, y: 329, nombre: "Punto 36" },
            "p37": { x: 571, y: 325, nombre: "Punto 37" },

            "b1": { x: 256, y: 343, nombre: "Ba√±o 1", tipo: "wc" }, "b2": { x: 226, y: 292, nombre: "Ba√±o 2", tipo: "wc" },
            "b3": { x: 424, y: 164, nombre: "Ba√±o 3", tipo: "wc" }, "b4": { x: 566, y: 125, nombre: "Ba√±o 4", tipo: "wc" },
            "b5": { x: 518, y: 181, nombre: "Ba√±o 5", tipo: "wc" },

            "e1": { x: 249, y: 357, nombre: "Escalera 1", tipo: "stair" }, "e2": { x: 218, y: 280, nombre: "Escalera 2", tipo: "stair" },
            "e3": { x: 147, y: 278, nombre: "Escalera 3", tipo: "stair" }, "e4": { x: 268, y: 175, nombre: "Escalera 4", tipo: "stair" },
            "e5": { x: 412, y: 163, nombre: "Escalera 5", tipo: "stair" }, "e6": { x: 527, y: 133, nombre: "Escalera 6", tipo: "stair" },
            "e7": { x: 508, y: 206, nombre: "Escalera 7", tipo: "stair" }, "e8": { x: 507, y: 232, nombre: "Escalera 8", tipo: "stair" },
            "e9": { x: 526, y: 321, nombre: "Escalera 9", tipo: "stair" },

            "a1": { x: 251, y: 341, nombre: "Ascensor 1", tipo: "lift" }, "a2": { x: 263, y: 174, nombre: "Ascensor 2", tipo: "lift" },
            "a3": { x: 282, y: 174, nombre: "Ascensor 3", tipo: "lift" }, "a4": { x: 402, y: 174, nombre: "Ascensor 4", tipo: "lift" },
            "a5": { x: 525, y: 317, nombre: "Ascensor 5", tipo: "lift" },

            "w1": { x: 272, y: 354, esOculto: true }, "w2": { x: 272, y: 343, esOculto: true },
            "w3": { x: 281, y: 326, esOculto: true }, "w4": { x: 311, y: 276, esOculto: true },
            "w5": { x: 311, y: 294, esOculto: true }, "w6": { x: 311, y: 325, esOculto: true },
            "w7": { x: 291, y: 325, esOculto: true }, "w8": { x: 244, y: 325, esOculto: true },
            "w9": { x: 236, y: 315, esOculto: true }, "w10": { x: 237, y: 288, esOculto: true },
            "w11": { x: 236, y: 270, esOculto: true }, "w12": { x: 225, y: 270, esOculto: true },
            "w13": { x: 226, y: 281, esOculto: true }, "w14": { x: 220, y: 276, esOculto: true },
            "w15": { x: 196, y: 279, esOculto: true }, "w16": { x: 205, y: 277, esOculto: true },
            "w17": { x: 216, y: 273, esOculto: true }, "w18": { x: 189, y: 271, esOculto: true },
            "w19": { x: 205, y: 271, esOculto: true }, "w20": { x: 174, y: 271, esOculto: true },
            "w21": { x: 164, y: 271, esOculto: true }, "w22": { x: 156, y: 271, esOculto: true },
            "w23": { x: 156, y: 278, esOculto: true }, "w24": { x: 119, y: 272, esOculto: true },
            "w25": { x: 94, y: 272, esOculto: true }, "w26": { x: 259, y: 356, esOculto: true },
            "w27": { x: 253, y: 348, esOculto: true }, "w28": { x: 236, y: 257, esOculto: true },
            "w29": { x: 236, y: 236, esOculto: true }, "w30": { x: 236, y: 184, esOculto: true },
            "w31": { x: 236, y: 175, esOculto: true }, "w32": { x: 236, y: 170, esOculto: true },
            "w33": { x: 242, y: 170, esOculto: true }, "w34": { x: 263, y: 170, esOculto: true },
            "w35": { x: 268, y: 170, esOculto: true }, "w36": { x: 277, y: 170, esOculto: true },
            "w37": { x: 291, y: 170, esOculto: true }, "w38": { x: 306, y: 170, esOculto: true },
            "w39": { x: 327, y: 170, esOculto: true }, "w40": { x: 352, y: 171, esOculto: true },
            "w41": { x: 401, y: 171, esOculto: true }, "w42": { x: 401, y: 162, esOculto: true },
            "w43": { x: 410, y: 161, esOculto: true }, "w44": { x: 419, y: 161, esOculto: true },
            "w45": { x: 430, y: 161, esOculto: true }, "w46": { x: 467, y: 161, esOculto: true },
            "w47": { x: 472, y: 161, esOculto: true }, "w48": { x: 472, y: 144, esOculto: true },
            "w49": { x: 493, y: 144, esOculto: true }, "w50": { x: 509, y: 140, esOculto: true },
            "w51": { x: 523, y: 140, esOculto: true }, "w52": { x: 544, y: 140, esOculto: true },
            "w53": { x: 561, y: 140, esOculto: true }, "w54": { x: 550, y: 129, esOculto: true },
            "w55": { x: 497, y: 162, esOculto: true }, "w56": { x: 487, y: 161, esOculto: true },
            "w57": { x: 510, y: 163, esOculto: true }, "w58": { x: 510, y: 169, esOculto: true },
            "w59": { x: 523, y: 169, esOculto: true }, "w60": { x: 524, y: 176, esOculto: true },
            "w61": { x: 524, y: 185, esOculto: true }, "w62": { x: 524, y: 201, esOculto: true },
            "w63": { x: 524, y: 220, esOculto: true }, "w64": { x: 513, y: 220, esOculto: true },
            "w65": { x: 525, y: 235, esOculto: true }, "w66": { x: 525, y: 249, esOculto: true },
            "w67": { x: 525, y: 259, esOculto: true }, "w68": { x: 506, y: 258, esOculto: true },
            "w69": { x: 491, y: 258, esOculto: true }, "w70": { x: 478, y: 258, esOculto: true },
            "w71": { x: 463, y: 256, esOculto: true }, "w72": { x: 525, y: 284, esOculto: true },
            "w73": { x: 526, y: 302, esOculto: true }, "w74": { x: 528, y: 310, esOculto: true },
            "w75": { x: 536, y: 313, esOculto: true }, "w76": { x: 543, y: 320, esOculto: true },
            "w77": { x: 550, y: 324, esOculto: true }
        };

        const conexiones = {
            "s1": ["w1"], "w1": ["s1", "w26", "w2"], "w26": ["w1", "s2", "e1", "w27"],
            "s2": ["w26", "e1"], "e1": ["w26", "s2", "w27"], "w27": ["w26", "e1", "r1", "b1"],
            "r1": ["w27", "b1"], "b1": ["w27", "r1"], "w2": ["w1", "s3"],
            "s3": ["w2", "w3", "w8"], "w3": ["s3", "w7"], "w7": ["w3", "s4", "w8", "w6"],
            "s4": ["w7"], "w9": ["w8", "w10"], "w8": ["w9", "w7", "s3"],
            "w6": ["w7", "w5"], "w5": ["w6", "w4"], "s5": ["w4", "w11"],
            "w4": ["s5", "w5"], "w11": ["s5", "w10", "w12", "w28"], "w10": ["w11", "w9"],
            "w12": ["w11", "w13", "w14"], "w13": ["w12", "b2", "e2", "w14"],
            "b2": ["w13"], "e2": ["w13", "w14"], "w14": ["e2", "w12", "w13", "w17"],
            "w17": ["w14", "w16", "w19"], "w16": ["w17", "w15"], "w15": ["w16", "s6"],
            "s6": ["w15", "w18"], "w18": ["s6", "w19", "w20"], "w19": ["w18", "w17"],
            "w20": ["w18", "w21"], "w21": ["w20", "s7", "w22"], "s7": ["w21"],
            "w23": ["w22", "e3", "s8"], "w22": ["w23", "w21", "w24"], "e3": ["w23"],
            "s8": ["w23"], "w24": ["w22", "s9", "w25"], "s9": ["w24"],
            "w25": ["w24", "s11", "s10"], "s11": ["w25"], "s10": ["w25"],
            "w28": ["w11", "s12", "s13", "w29"], "s12": ["w28"], "s13": ["w28"],
            "w29": ["w28", "s14", "s15", "w30"], "s14": ["w29"], "s15": ["w29"],
            "w30": ["w29", "s16", "s17", "w31"], "s16": ["w30"], "s17": ["w30"],
            "w31": ["w30", "w32"], "w32": ["w31", "w33"], "w33": ["w32", "s18", "w34"],
            "s18": ["w33"], "w34": ["w33", "r2", "w35"], "r2": ["w34"],
            "e4": ["w35"], "w35": ["e4", "w34", "s19", "w36"], "s19": ["w35", "w36"],
            "w36": ["w35", "s19", "r3", "w37"], "r3": ["w36", "w37"],
            "w37": ["w36", "r3", "w38", "s20"], "w38": ["w37", "s20", "s21", "w39"],
            "s20": ["w37", "w38"], "s21": ["w38", "w39"], "w39": ["w38", "s22", "w40", "s21"],
            "s22": ["w39"], "w40": ["w39", "w41"], "w41": ["w40", "r4", "w42"],
            "r4": ["w41"], "w42": ["w41", "w43"], "w43": ["w42", "e5", "w44", "s23"],
            "e5": ["w43", "w44"], "w44": ["w43", "s23", "e5", "w45", "b3"],
            "s23": ["w44", "w43"], "w45": ["w44", "b3", "w46"], "b3": ["w45", "w44"],
            "w46": ["w45", "s24", "w47"], "s24": ["w46", "w47"], "w47": ["s24", "w46", "w48", "w56"],
            "w48": ["w47", "s26", "s27"], "s26": ["w48", "w49"], "s27": ["w48"],
            "w49": ["s26", "w50"], "w50": ["w49", "w51"], "w51": ["w50", "e6", "w52"],
            "e6": ["w51"], "w52": ["w51", "w54", "w53"], "w54": ["w52", "s28", "b4", "w53"],
            "s28": ["w54"], "b4": ["w54", "w53"], "w53": ["w52", "b4", "w54"],
            "w56": ["w47", "s25"], "s25": ["w56", "w55"], "w55": ["s25", "w57"],
            "w57": ["w55", "w58"], "w58": ["w57", "w59"], "w59": ["w58", "w60"],
            "w60": ["w59", "s29", "b5", "w61"], "s29": ["w60", "w61"], "b5": ["w60", "w61"],
            "w61": ["w60", "s29", "b5", "w62", "s30"], "s30": ["w62", "w61", "w63"],
            "w62": ["s30", "w61", "w63"], "w63": ["w62", "s30", "w64", "w65"],
            "w64": ["w63", "s31", "e8", "e7"], "s31": ["w64", "e7", "e8"],
            "e8": ["w64", "e7", "s31"], "e7": ["e8", "s31", "w64"], "w65": ["w63", "w66", "s32"],
            "w66": ["w65", "s32", "w67"], "s32": ["w66", "w65"], "w67": ["w66", "s34", "w72"],
            "s34": ["w67", "w68"], "w68": ["s34", "w69"], "w69": ["w68", "w70"],
            "w70": ["w69", "w71"], "w71": ["w70", "s35"], "s35": ["w71"],
            "w72": ["w67", "s33", "w73"], "s33": ["w72"], "w73": ["w72", "w74"],
            "w74": ["w73", "r5", "e9", "w75"], "r5": ["w74", "e9"],
            "e9": ["r5", "w74"], "w75": ["w74", "w76"], "w76": ["w75", "s36", "w77"],
            "s36": ["w76", "w77"], "w77": ["s36", "w76", "s37"], "s37": ["w77"]
        };

        // === INICIALIZACI√ìN ===
        let map, origen = null, layerRuta = null, marcadorJugador;
        const imgObj = new Image();
        imgObj.src = 'mapa.svg';

        imgObj.onload = function() {
            // Poblar selects antes de todo
            poblarSelects();

            const w = imgObj.naturalWidth;
            const h = imgObj.naturalHeight;
            
            map = L.map('map', {
                crs: L.CRS.Simple, minZoom: -2, maxZoom: 3, zoomSnap: 0.5, attributionControl: false, zoomControl: false
            });
            const bounds = [[0, 0], [h, w]];
            L.imageOverlay('mapa.svg', bounds).addTo(map);
            map.fitBounds(bounds);

            // Dibujar servicios + puntos
            dibujarNodos(h);

            // Check QR
            const p = new URLSearchParams(window.location.search);
            if(p.get('inicio')) {
                // Si viene por QR, saltamos la selecci√≥n manual
                document.getElementById('modal-inicio').style.display = 'none';
                fijarInicio(p.get('inicio'));
            }
        };

        function xy(x, y) { return [imgObj.naturalHeight - y, x]; }

        function dibujarNodos(h) {
            for(let id in nodos) {
                const n = nodos[id];
                // Si es un servicio, pintamos icono
                if(n.tipo) {
                    let css = "icon-marker ";
                    let emoji = "";
                    if(n.tipo === 'wc') { css += "icon-wc"; emoji = "üöæ"; }
                    if(n.tipo === 'stair') { css += "icon-stair"; emoji = "ü™ú"; }
                    if(n.tipo === 'lift') { css += "icon-lift"; emoji = "üõó"; }

                    const icon = L.divIcon({ className: css, html: emoji, iconSize: [24, 24], iconAnchor: [12, 12] });
                    const marker = L.marker(xy(n.x, n.y), {icon: icon}).addTo(map);
                    
                    // Hacemos que los iconos tambi√©n sean clicables para elegir origen
                    marker.on('click', () => seleccionarDesdeMapa(id));
                } 
                // Si es un punto normal (aula)
                else if (!n.esOculto) {
                    const icon = L.divIcon({ className: 'punto-rojo', iconSize: [16, 16], iconAnchor: [8, 8] });
                    const marker = L.marker(xy(n.x, n.y), {icon: icon}).addTo(map);
                    marker.on('click', () => seleccionarDesdeMapa(id));
                }
            }
        }

        function poblarSelects() {
            const startSel = document.getElementById('start-select');
            const searchSel = document.getElementById('search-select');
            const optLugares = document.getElementById('opt-lugares');

            const keys = Object.keys(nodos).sort((a,b) => nodos[a].nombre.localeCompare(nodos[b].nombre));

            keys.forEach(k => {
                const n = nodos[k];
                if(!n.esOculto) {
                    // Lista Inicio
                    startSel.add(new Option(n.nombre, k));
                    // Lista Buscador
                    const opt = new Option(n.nombre, k);
                    if(!n.tipo) optLugares.appendChild(opt); // Solo lugares en el grupo, servicios van arriba
                }
            });
        }

        // === L√ìGICA INTERACCI√ìN ===

        function activarModoMapa() {
            document.getElementById('modal-inicio').style.display = 'none';
            document.getElementById('aviso-mapa').style.display = 'block';
        }

        function seleccionarDesdeMapa(id) {
            // Si a√∫n no hay origen definido, este clic define el origen
            if(!origen) {
                document.getElementById('modal-inicio').style.display = 'none'; // Asegurar que se cierra
                document.getElementById('aviso-mapa').style.display = 'none';
                fijarInicio(id);
            } 
            // Si ya hay origen, calculamos ruta
            else {
                // (Opcional: podr√≠as querer que al tocar un destino vaya all√≠)
                // Por ahora el clic en mapa solo define origen si no hay
            }
        }

        function confirmarInicio() {
            const val = document.getElementById('start-select').value;
            if(!val) return alert("Elige una opci√≥n");
            fijarInicio(val);
        }

        function fijarInicio(id) {
            origen = id;
            document.getElementById('modal-inicio').style.display = 'none';
            document.getElementById('search-container').style.display = 'block';

            const icon = L.divIcon({className:'user-arrow', iconSize:[24,24], iconAnchor:[12,12]});
            if(marcadorJugador) map.removeLayer(marcadorJugador);
            marcadorJugador = L.marker(xy(nodos[id].x, nodos[id].y), {icon: icon}).addTo(map).bindTooltip("Est√°s aqu√≠").openTooltip();
            
            map.setView(xy(nodos[id].x, nodos[id].y), 1);
        }

        function gestionarBusqueda(val) {
            if(val.startsWith('TYPE_')) buscarMasCercano(val);
            else calcularRuta(val);
        }

        function buscarMasCercano(tipo) {
            let prefijo = "";
            if(tipo === 'TYPE_WC') prefijo = 'b';
            if(tipo === 'TYPE_STAIR') prefijo = 'e';
            if(tipo === 'TYPE_LIFT') prefijo = 'r'; // Ojo: tus ascensores son 'a' en nodos, pero 'r' en tu logica anterior. REVISAR.
            // REVISANDO TU DATA: Ascensores son 'a1', 'a2'... -> prefijo 'a'
            if(tipo === 'TYPE_LIFT') prefijo = 'a'; 

            const candidatos = Object.keys(nodos).filter(k => k.startsWith(prefijo));
            let mejor = null, minDist = Infinity;

            candidatos.forEach(dest => {
                const path = getPathBFS(origen, dest);
                if(path) {
                    const d = getDistancia(path);
                    if(d < minDist) { minDist = d; mejor = dest; }
                }
            });

            if(mejor) {
                alert("El m√°s cercano es: " + nodos[mejor].nombre);
                calcularRuta(mejor);
            } else {
                alert("No se encontr√≥ ruta.");
            }
        }

        function getPathBFS(start, end) {
            let q=[[start]], v=new Set();
            while(q.length>0){
                let path=q.shift(), curr=path[path.length-1];
                if(curr===end) return path;
                if(!v.has(curr)){
                    v.add(curr);
                    (conexiones[curr]||[]).forEach(n=>q.push([...path, n]));
                }
            }
            return null;
        }

        function getDistancia(path) {
            let d = 0;
            for(let i=0; i<path.length-1; i++) {
                let a = nodos[path[i]], b = nodos[path[i+1]];
                d += Math.sqrt(Math.pow(b.x-a.x, 2) + Math.pow(b.y-a.y, 2));
            }
            return d;
        }

        function calcularRuta(destino) {
            const path = getPathBFS(origen, destino);
            if(path) {
                if(layerRuta) map.removeLayer(layerRuta);
                const pts = path.map(id => xy(nodos[id].x, nodos[id].y));
                
                layerRuta = L.polyline(pts, { color: '#3498db', weight: 6, opacity: 0.9, lineCap: 'round' }).addTo(map);
                map.fitBounds(layerRuta.getBounds(), {padding:[50,150]});

                // Datos
                const dist = getDistancia(path);
                const t = Math.round(dist/VELOCIDAD);
                const tStr = t < 60 ? t + " s" : Math.ceil(t/60) + " min";
                const dStr = Math.round(dist/20);

                document.getElementById('card-title').innerText = "Ir a " + nodos[destino].nombre;
                document.getElementById('lbl-time').innerText = tStr;
                document.getElementById('lbl-dist').innerText = `(${dStr} m)`;
                document.getElementById('info-card').classList.add('visible');
            }
        }
    </script>
</body>
</html>