<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa Hospital - Versi√≥n Estable</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* === ESTILOS B√ÅSICOS === */
        body { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; font-family: sans-serif; background: #222; }
        #map { width: 100%; height: 100%; background: #222; }

        /* === PANEL DE ESTADO (Arriba) === */
        #ui-layer {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 400px;
            background: rgba(255, 255, 255, 0.95); padding: 12px 20px;
            border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-align: center; font-weight: bold; color: #333;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* === VISOR FLOTANTE (Abajo) === */
        #visor-nodo {
            position: fixed; bottom: -100%; left: 0; width: 100%;
            background: white; z-index: 9999;
            border-radius: 20px 20px 0 0;
            padding: 20px; box-sizing: border-box;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.4);
            transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; gap: 10px;
        }
        #visor-nodo.activo { bottom: 0; }

        .visor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .visor-header h3 { margin: 0; font-size: 18px; color: #2c3e50; }
        
        .contenedor-foto { 
            width: 100%; height: 200px; background: #f0f0f0; 
            border-radius: 12px; overflow: hidden; position: relative;
        }
        #visor-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .sin-foto-texto {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #999; font-size: 14px;
        }

        .btn-cerrar { background: #f0f0f0; border: none; font-size: 18px; cursor: pointer; color: #666; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;}

        /* === BOT√ìN DE ACCI√ìN INTELIGENTE === */
        #btn-accion-visor {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-weight: 800; font-size: 16px; color: white; cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #btn-accion-visor:active { transform: scale(0.98); }

        /* === ELEMENTOS DEL MAPA === */
        .punto-rojo {
            background-color: #e74c3c; border: 2px solid white;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .punto-rojo:active { transform: scale(1.5); }

        .flecha-azul {
            width: 0; height: 0;
            border-left: 12px solid transparent; 
            border-right: 12px solid transparent;
            border-bottom: 24px solid #2980b9;
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.4));
            /* Usamos margin para animar, NO transform */
            animation: flotar 1s infinite alternate ease-in-out;
        }

        @keyframes flotar { 
            from { margin-top: -12px; } 
            to { margin-top: -22px; } 
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <span id="texto-estado">üìç Toca un punto rojo para empezar</span>
    </div>

    <div id="visor-nodo">
        <div class="visor-header">
            <h3 id="visor-titulo">Nombre del lugar</h3>
            <button class="btn-cerrar" onclick="cerrarVisor()">‚úï</button>
        </div>
        
        <div class="contenedor-foto">
            <span class="sin-foto-texto">üì∑ Sin foto</span>
            <img id="visor-img" src="" alt="Foto de referencia" onerror="this.style.display='none'">
        </div>

        <button id="btn-accion-visor" onclick="ejecutarAccionVisor()">Acci√≥n</button>
    </div>

    <div id="map"></div>

    <script>
        // ============================================================
        // 1. CONFIGURACI√ìN DE TAMA√ëO FIJO (Aqu√≠ est√° la soluci√≥n)
        // ============================================================
        const MAPA_ANCHO = 1152; // Tus medidas exactas
        const MAPA_ALTO = 648;   // Tus medidas exactas

        // ============================================================
        // 2. DATOS (Fusi√≥n de visible e invisible)
        // ============================================================
        const nodos = {
            // --- LUGARES VISIBLES ---
            "entrada":    { x: 408, y: 500, nombre: "Entrada Principal", foto: "fotos/entrada.jpg" },
            "hab_gabri":  { x: 412, y: 332, nombre: "Hab. Gabri",        foto: "fotos/habitacion.jpg" },
            "cocina":     { x: 378, y: 177, nombre: "Cocina",            foto: "fotos/cocina.jpg" },
            "hall":       { x: 406, y: 217, nombre: "Hall Central",      foto: "fotos/hall.jpg" },
            "bano_1":     { x: 540, y: 185, nombre: "Ba√±o 1",            foto: "" },
            "hab_tobi":   { x: 587, y: 170, nombre: "Hab. Tobi",         foto: "" },
            "hab_snoopy": { x: 587, y: 74,  nombre: "Hab. Snoopy",       foto: "" },
            "bano_2":     { x: 902, y: 290, nombre: "Ba√±o 2",            foto: "" },

            // --- RIELES INVISIBLES (Waypoints) ---
            "rail_v1": { x: 408, y: 400, esOculto: true }, 
            "rail_v2": { x: 408, y: 280, esOculto: true },
            "rotonda": { x: 408, y: 185, esOculto: true },
            "rail_h1": { x: 480, y: 185, esOculto: true },
            "rail_h2": { x: 587, y: 185, esOculto: true },
            "giro_snoopy": { x: 700, y: 185, esOculto: true },
            "entrada_snoopy": { x: 760, y: 74, esOculto: true },
            "fondo_pasillo": { x: 902, y: 185, esOculto: true }
        };

        const conexiones = {
            "entrada": ["rail_v1"],
            "rail_v1": ["entrada", "hab_gabri", "rail_v2"],
            "hab_gabri": ["rail_v1", "rail_v2"],
            "rail_v2": ["rail_v1", "rotonda", "hall"], 
            "hall": ["rail_v2"],
            "rotonda": ["rail_v2", "cocina", "rail_h1"],
            "cocina": ["rotonda"],
            "rail_h1": ["rotonda", "bano_1", "rail_h2"],
            "bano_1":  ["rail_h1"],
            "rail_h2": ["rail_h1", "hab_tobi", "giro_snoopy"],
            "hab_tobi":["rail_h2"],
            "giro_snoopy": ["rail_h2", "entrada_snoopy", "fondo_pasillo"],
            "entrada_snoopy": ["giro_snoopy", "hab_snoopy"],
            "hab_snoopy": ["entrada_snoopy"],
            "fondo_pasillo": ["giro_snoopy", "bano_2"],
            "bano_2": ["fondo_pasillo"]
        };

        // ============================================================
        // 3. INICIALIZACI√ìN
        // ============================================================
        let map;
        let layerRuta;
        let marcadorJugador;
        
        // Estados
        let nodoVisualizado = null;
        let origen = null;
        let destino = null;

        // Iniciamos directamente, SIN esperar a cargar la imagen
        // porque ya sabemos cu√°nto mide.
        window.onload = function() {
            iniciarMapa();
        };

        function iniciarMapa() {
            map = L.map('map', {
                crs: L.CRS.Simple, 
                minZoom: -2, maxZoom: 2, zoomSnap: 0.5, 
                attributionControl: false
            });

            // USAMOS LAS MEDIDAS FIJAS
            const bounds = [[0, 0], [MAPA_ALTO, MAPA_ANCHO]];
            L.imageOverlay('mapa.jpg', bounds).addTo(map);
            map.fitBounds(bounds);

            dibujarNodos();

            const p = new URLSearchParams(window.location.search);
            if(p.get('inicio') && nodos[p.get('inicio')]) {
                nodoVisualizado = p.get('inicio');
                ejecutarAccionVisor(); 
            }
        }

        // CONVERTIDOR DE COORDENADAS ROBUSTO
        function xy(x, y) { 
            // Usamos MAPA_ALTO fijo. Esto no falla nunca.
            return [MAPA_ALTO - y, x]; 
        }

        function dibujarNodos() {
            for(let id in nodos) {
                let n = nodos[id];
                if(n.esOculto) continue;

                const icono = L.divIcon({className: 'punto-rojo', iconSize: [20, 20], iconAnchor: [10, 10]});
                
                L.marker(xy(n.x, n.y), {icon: icono})
                    .addTo(map)
                    .on('click', () => clickNodo(id));
            }
        }

        // ============================================================
        // 4. INTERACTIVIDAD
        // ============================================================

        function clickNodo(id) {
            nodoVisualizado = id;
            const info = nodos[id];

            document.getElementById('visor-titulo').innerText = info.nombre;
            const img = document.getElementById('visor-img');
            
            img.style.display = 'none';
            if(info.foto) {
                img.src = info.foto;
                img.style.display = 'block';
            }

            const btn = document.getElementById('btn-accion-visor');
            
            if (origen === null) {
                btn.innerText = "üìç ESTOY AQU√ç (Empezar)";
                btn.style.background = "#27ae60";
                btn.style.color = "white";
            } 
            else if (id === destino) {
                btn.innerText = "üéâ ¬°HE LLEGADO!";
                btn.style.background = "#f1c40f";
                btn.style.color = "#333";
            } 
            else {
                btn.innerText = "üèÅ IR AQU√ç";
                btn.style.background = "#3498db";
                btn.style.color = "white";
            }

            document.getElementById('visor-nodo').classList.add('activo');
        }

        function cerrarVisor() {
            document.getElementById('visor-nodo').classList.remove('activo');
        }

        function ejecutarAccionVisor() {
            if (origen === null) {
                fijarOrigen(nodoVisualizado);
            } else if (nodoVisualizado === destino) {
                alert("¬°Enhorabuena! Has llegado a tu destino.");
                location.reload();
            } else {
                fijarDestino(nodoVisualizado);
            }
            cerrarVisor();
        }

        // ============================================================
        // 5. RUTAS
        // ============================================================

        function fijarOrigen(id) {
            origen = id;
            const n = nodos[id];
            
            const iconoFlecha = L.divIcon({ className: 'flecha-azul', iconSize: [24, 24], iconAnchor: [12, 12] });
            if(marcadorJugador) map.removeLayer(marcadorJugador);
            marcadorJugador = L.marker(xy(n.x, n.y), {icon: iconoFlecha}).addTo(map);
            
            map.setView(xy(n.x, n.y), 0);
            document.getElementById('texto-estado').innerText = "Origen fijado: " + n.nombre;
        }

        function fijarDestino(id) {
            destino = id;
            calcularRuta(origen, destino);
            document.getElementById('texto-estado').innerText = "Yendo a: " + nodos[destino].nombre;
        }

        function calcularRuta(ini, fin) {
            let q = [[ini]], visitados = new Set();
            let rutaEncontrada = null;

            while(q.length > 0) {
                let camino = q.shift();
                let actual = camino[camino.length - 1];

                if(actual === fin) {
                    rutaEncontrada = camino;
                    break;
                }

                if(!visitados.has(actual)) {
                    visitados.add(actual);
                    let vecinos = conexiones[actual] || [];
                    for(let vecino of vecinos) {
                        q.push([...camino, vecino]);
                    }
                }
            }

            if(rutaEncontrada) {
                dibujarLinea(rutaEncontrada);
            } else {
                alert("‚ùå Error: No hay camino conectado hasta aqu√≠.");
            }
        }

        function dibujarLinea(ids) {
            if(layerRuta) map.removeLayer(layerRuta);
            
            const puntos = ids.map(id => xy(nodos[id].x, nodos[id].y));
            
            layerRuta = L.polyline(puntos, {
                color: '#3498db', weight: 6, opacity: 0.8, 
                dashArray: '10, 15', lineCap: 'round', lineJoin: 'round'
            }).addTo(map);

            map.fitBounds(layerRuta.getBounds(), {padding: [50, 50]});
        }

    </script>
</body>
</html>