<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa Interactivo con Referencias</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* === ESTILOS B√ÅSICOS === */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #333;
        }

        /* === CAPA DE ESTADO (Texto arriba) === */
        #ui-layer {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            font-weight: bold;
            color: #333;
        }

        /* === VISOR FLOTANTE (Tarjeta de fotos) === */
        #visor-nodo {
            position: fixed;
            bottom: -100%;
            left: 0;
            width: 100%;
            background: white;
            z-index: 9999;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            transition: bottom 0.3s ease-out;
            /* Animaci√≥n suave */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #visor-nodo.activo {
            bottom: 0;
        }

        /* Clase para mostrarlo */

        .visor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .visor-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .contenedor-foto {
            width: 100%;
            height: 200px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
        }

        #visor-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-cerrar {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0 10px;
        }

        /* Bot√≥n de Acci√≥n Inteligente */
        #btn-accion-visor {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 16px;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* === ICONOS DEL MAPA === */
        .punto-rojo {
            background-color: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .flecha-azul {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #2980b9;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.5));
        }
    </style>
</head>

<body>

    <div id="ui-layer">
        <span id="texto-estado">Toca un punto para empezar</span>
    </div>

    <div id="visor-nodo">
        <div class="visor-header">
            <h3 id="visor-titulo">Lugar</h3>
            <button class="btn-cerrar" onclick="cerrarVisor()">‚úñ</button>
        </div>

        <div class="contenedor-foto">
            <img id="visor-img" src="" alt="Foto de referencia">
        </div>

        <button id="btn-accion-visor" onclick="ejecutarAccionVisor()">Acci√≥n</button>
    </div>

    <div id="map"></div>

    <script>
        // ==========================================
        // 1. CONFIGURACI√ìN DE DATOS (EDITAR ESTO)
        // ==========================================

        // A√±ade aqu√≠ tus nodos con la propiedad 'foto' apuntando a tu carpeta
        const nodos = {
            "entrada": { x: 408, y: 500, nombre: "Entrada Principal", foto: "fotos/entrada.jpg" },
            "hall": { x: 406, y: 217, nombre: "Hall Central", foto: "fotos/hall.jpg" },
            "hab_gabri": { x: 412, y: 332, nombre: "Hab. Gabri", foto: "" }, // Sin foto usa la gen√©rica
            "cocina": { x: 378, y: 177, nombre: "Cocina", foto: "" },
            "bano_1": { x: 540, y: 185, nombre: "Ba√±o 1", foto: "" },
            "hab_tobi": { x: 587, y: 170, nombre: "Hab. Tobi", foto: "" },
            "hab_snoopy": { x: 587, y: 74, nombre: "Hab. Snoopy", foto: "" },
            "bano_2": { x: 902, y: 290, nombre: "Ba√±o 2", foto: "" }
        };

        const conexiones = {
            "entrada": ["hall", "hab_gabri"], "hab_gabri": ["entrada", "hall"],
            "hall": ["entrada", "hab_gabri", "cocina", "bano_1", "hab_tobi", "hab_snoopy"],
            "cocina": ["hall"], "bano_1": ["hall"], "hab_tobi": ["hall"],
            "hab_snoopy": ["hall", "bano_2"], "bano_2": ["hab_snoopy"]
        };

        // ==========================================
        // 2. L√ìGICA DEL PROGRAMA
        // ==========================================

        let map;
        let imgObj = new Image();
        let layerPuntos = [];
        let layerRuta;
        let marcadorJugador;

        // Variables de Estado
        let nodoVisualizado = null; // El que estamos viendo en la foto
        let origen = null;          // Donde empieza la ruta
        let destino = null;         // A donde queremos ir

        // Cargar imagen para saber tama√±o real
        imgObj.src = 'mapa.jpg';
        imgObj.onload = function () { iniciarMapa(imgObj.naturalWidth, imgObj.naturalHeight); };
        imgObj.onerror = function () { alert("ERROR: No encuentro 'mapa.jpg'. Pon la imagen en la misma carpeta."); };

        function iniciarMapa(w, h) {
            map = L.map('map', {
                crs: L.CRS.Simple, minZoom: -2, maxZoom: 2, zoomSnap: 0.5
            });

            const bounds = [[0, 0], [h, w]];
            L.imageOverlay('mapa.jpg', bounds).addTo(map);
            map.fitBounds(bounds);

            // Dibujar los puntos rojos interactivos
            dibujarNodos(h);

            // Si hay QR (par√°metro URL), iniciamos ah√≠
            const p = new URLSearchParams(window.location.search);
            if (p.get('inicio') && nodos[p.get('inicio')]) {
                fijarOrigen(p.get('inicio'));
            }
        }

        // Conversor de coordenadas (Invertir Y)
        function xy(x, y) {
            const h = imgObj.naturalHeight;
            return [h - y, x];
        }

        function dibujarNodos(h) {
            for (let id in nodos) {
                let n = nodos[id];
                const icono = L.divIcon({ className: 'punto-rojo', iconSize: [20, 20], iconAnchor: [10, 10] });

                L.marker(xy(n.x, n.y), { icon: icono })
                    .addTo(map)
                    .on('click', () => clickNodo(id)); // Al hacer clic, abrimos el visor
            }
        }

        // --- GESTI√ìN DEL CLIC Y EL VISOR ---

        function clickNodo(id) {
            nodoVisualizado = id;
            const info = nodos[id];

            // 1. Cargar Info y Foto (Igual que antes)
            document.getElementById('visor-titulo').innerText = info.nombre;
            const img = document.getElementById('visor-img');

            if (info.foto) {
                img.src = info.foto;
                img.style.display = 'block';
            } else {
                img.src = 'https://via.placeholder.com/400x200?text=Sin+Foto';
            }

            // 2. CONFIGURAR BOT√ìN (L√ìGICA MEJORADA)
            const btn = document.getElementById('btn-accion-visor');

            if (origen === null) {
                // CASO A: A√∫n no hemos empezado
                btn.innerText = "üìç ESTOY AQU√ç (Fijar Inicio)";
                btn.style.backgroundColor = "#27ae60"; // Verde
            }
            else if (id === destino) {
                // CASO B: ¬°Hemos tocado nuestro destino actual!
                btn.innerText = "üéâ ¬°YA HE LLEGADO! (Finalizar)";
                btn.style.backgroundColor = "#f1c40f"; // Amarillo/Dorado
                btn.style.color = "#333"; // Letra oscura para que se lea bien
            }
            else {
                // CASO C: Queremos ir a un sitio nuevo
                btn.innerText = "üèÅ IR AQU√ç (Calcular Ruta)";
                btn.style.backgroundColor = "#3498db"; // Azul
                btn.style.color = "white";
            }

            // 3. Mostrar Visor
            document.getElementById('visor-nodo').classList.add('activo');
        }

        function cerrarVisor() {
            document.getElementById('visor-nodo').classList.remove('activo');
        }

        function ejecutarAccionVisor() {
            if (origen === null) {
                // 1. Fijar el inicio
                fijarOrigen(nodoVisualizado);

            } else if (nodoVisualizado === destino) {
                // 2. FINALIZAR RUTA (El usuario ha llegado)
                alert("¬°Enhorabuena! Has llegado a " + nodos[destino].nombre);

                // Reiniciamos todo para la siguiente persona
                location.reload();

            } else {
                // 3. Calcular ruta normal
                fijarDestino(nodoVisualizado);
            }

            cerrarVisor();
        }

        // --- FUNCIONES DE NAVEGACI√ìN ---

        function fijarOrigen(id) {
            origen = id;
            const n = nodos[id];

            // Poner marcador de "Persona"
            const iconoFlecha = L.divIcon({ className: 'flecha-azul', iconSize: [20, 20], iconAnchor: [10, 10] });
            if (marcadorJugador) map.removeLayer(marcadorJugador);
            marcadorJugador = L.marker(xy(n.x, n.y), { icon: iconoFlecha }).addTo(map);

            map.setView(xy(n.x, n.y), 0); // Zoom al usuario
            document.getElementById('texto-estado').innerText = "Origen: " + n.nombre + ". Selecciona destino.";
        }

        function fijarDestino(id) {
            destino = id;
            calcularRuta(origen, destino);
            document.getElementById('texto-estado').innerText = "Ruta hacia: " + nodos[destino].nombre;
        }

        function calcularRuta(ini, fin) {
            // Algoritmo BFS (B√∫squeda en anchura) para encontrar camino corto
            let q = [[ini]], visitados = new Set();
            let rutaEncontrada = null;

            while (q.length > 0) {
                let camino = q.shift();
                let actual = camino[camino.length - 1];

                if (actual === fin) {
                    rutaEncontrada = camino;
                    break;
                }

                if (!visitados.has(actual)) {
                    visitados.add(actual);
                    let vecinos = conexiones[actual] || [];
                    for (let vecino of vecinos) {
                        q.push([...camino, vecino]);
                    }
                }
            }

            if (rutaEncontrada) {
                dibujarLinea(rutaEncontrada);
            } else {
                alert("No hay camino conectado entre estos puntos en tus datos.");
            }
        }

        function dibujarLinea(ids) {
            if (layerRuta) map.removeLayer(layerRuta);
            const puntos = ids.map(id => xy(nodos[id].x, nodos[id].y));

            layerRuta = L.polyline(puntos, {
                color: '#3498db', weight: 6, opacity: 0.8, dashArray: '10, 10'
            }).addTo(map);

            // Ajustar mapa para ver toda la ruta
            map.fitBounds(layerRuta.getBounds(), { padding: [50, 50] });
        }

    </script>
</body>

</html>