<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calibrador con Leaflet (El Bueno)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { display: flex; margin: 0; height: 100vh; font-family: monospace; overflow: hidden; }
        
        /* EL MAPA OCUPA CASI TODO */
        #map { flex: 3; background: #333; cursor: crosshair; }
        
        /* BARRA LATERAL */
        #sidebar {
            flex: 1; min-width: 300px; max-width: 400px;
            background: #111; color: #0f0; border-left: 2px solid #555;
            display: flex; flex-direction: column; padding: 15px;
        }
        textarea { 
            flex: 1; background: #000; color: #0f0; border: 1px solid #444; 
            padding: 10px; resize: none; margin-top: 10px; font-size: 11px;
        }
        h3 { margin: 0 0 10px 0; color: white; }
        button { padding: 10px; margin-top: 5px; cursor: pointer; font-weight: bold; }
        
        /* Estilo del marcador temporal */
        .punto-temp {
            width: 10px; height: 10px; background: red; 
            border: 2px solid yellow; border-radius: 50%;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="sidebar">
        <h3>Extractor Leaflet</h3>
        <p style="color:#aaa; font-size:12px; margin:0;">
            1. Haz zoom y muévete libremente.<br>
            2. Clic en el punto exacto.<br>
            3. Copia el código final.
        </p>
        <textarea id="output"></textarea>
        <button onclick="copiar()" style="background:#27ae60; color:white; border:none;">COPIAR CÓDIGO</button>
        <button onclick="borrarUltimo()" style="background:#e67e22; color:white; border:none;">Deshacer Último</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. CARGAR IMAGEN PARA SABER TAMAÑO
        const img = new Image();
        // SI TU ARCHIVO SE LLAMA DE OTRA FORMA, CAMBIALO AQUÍ:
        img.src = 'mapa.svg'; 

        let map;
        let contador = 1;
        let marcadores = [];

        img.onload = function() {
            const w = img.naturalWidth;
            const h = img.naturalHeight;
            iniciarMapa(w, h);
        }

        img.onerror = function() {
            alert("❌ ERROR: No encuentro 'mapa.svg'. Asegúrate de que está en la misma carpeta.");
        }

        function iniciarMapa(w, h) {
            // Iniciar Leaflet
            map = L.map('map', {
                crs: L.CRS.Simple, // Modo plano (no terrestre)
                minZoom: -2,
                maxZoom: 4,        // Permite mucho zoom
                zoomSnap: 0.5
            });

            // Límites de la imagen: [[0,0], [alto, ancho]]
            // OJO: Leaflet usa Y hacia arriba. 
            const bounds = [[0, 0], [h, w]];

            // Cargar imagen
            L.imageOverlay(img.src, bounds).addTo(map);
            map.fitBounds(bounds);

            // EVENTO CLIC
            map.on('click', function(e) {
                // Leaflet nos da coordenadas (lat, lng)
                // Lat = Y (desde abajo), Lng = X (desde izquierda)
                
                // Convertimos a coordenadas de Imagen (Y desde arriba)
                // Para que coincida con tu lógica visual
                const x = Math.round(e.latlng.lng);
                const y = Math.round(h - e.latlng.lat); 

                // Añadir marcador visual en el mapa
                const icon = L.divIcon({ className: 'punto-temp', iconSize: [10,10], iconAnchor: [5,5] });
                const marker = L.marker(e.latlng, {icon: icon}).addTo(map);
                marcadores.push(marker);

                // Generar texto JSON
                const nombre = "Punto " + contador;
                const linea = `"${contador}": { x: ${x}, y: ${y}, nombre: "${nombre}" },\n`;
                
                const textarea = document.getElementById('output');
                textarea.value += linea;
                textarea.scrollTop = textarea.scrollHeight;
                
                contador++;
            });
        }

        function borrarUltimo() {
            const textarea = document.getElementById('output');
            const lines = textarea.value.trim().split('\n');
            
            if (lines.length > 0 && lines[0] !== "") {
                // Borrar texto
                lines.pop();
                textarea.value = lines.join('\n') + (lines.length ? '\n' : '');
                
                // Borrar marcador del mapa
                const ultimoMarker = marcadores.pop();
                if (ultimoMarker) map.removeLayer(ultimoMarker);
                
                contador--;
            }
        }

        function copiar() {
            document.getElementById('output').select();
            document.execCommand('copy');
            alert("Copiado!");
        }
    </script>
</body>
</html>